var m_names=new Array("January","February","March","April","May","June","July","August","September","October","November","December");Handlebars.registerHelper("formatDate",function(a){a=String(a);var b=a.substring(0,4),c=a.substring(4,6);c=c.replace(/^0+/,"");var d=m_names[c-1];return d+", "+b}),Handlebars.registerHelper("getImgPath",function(a){var b=a.thumbnail,c="Guardian"===a.newspaper?"guardian":"nytimes",d="http://marijerooze.nl/thesis/graphics/images/"+c+"/"+b;return d}),Handlebars.registerHelper("setFavicon",function(a){var b="Guardian"===a?"gua":"nyt";return b+=" favicon"}),Handlebars.registerHelper("setToLowerCase",function(a){return a.toLowerCase()}),Handlebars.registerHelper("setSelected",function(a,b){return sel=a.selection===b?"selected":""});var APP=window.APP={};Backbone.controller=_.extend({},Backbone.Events),Backbone.isiPad=null!=navigator.userAgent.match(/iPad/i),APP.Facets=Backbone.Model.extend({defaults:{facet:"",heading:"",sort_order:""},url:"/public/data/facets.json"}),APP.Graphic=Backbone.Model.extend({defaults:{id:"",title:"undefined",date:null,source:"unknown",creators:"unknown",favorite:!1,thumbnail:"public/img/graphics/test.jpg",news_type:"unknown",annotated_type:"unknown",flash:"unknown"}}),APP.Graphics=Backbone.Collection.extend({model:APP.Graphic,url:"../graphics",sortKey:"desc",comparator:function(a,b){return name1=a.get("date").toLowerCase(),name2=b.get("date").toLowerCase(),ret=name2>name1?-1:name1>name2?1:0,"desc"===this.sort_dir&&(ret=-ret),ret},initialize:function(){this.on("change",this.viewRefresh,this),this.sortByColumn(this.sortKey)},sortByColumn:function(a){this.sortkey=a,this.sort_dir="asc"===a?"asc":"desc",this.sort()}}),APP.FacetsMasterView=Backbone.View.extend({initialize:function(){this.initSearch(),this.initSort(),this.initFacet(),this.initSelectedFilters(),Backbone.controller.on("removedSelectedFilter",this.removedSelectedFilter,this)},initSearch:function(){var a=this,b=new APP.SearchView({el:$(".search-wrapper")});b.on("search_Changed",function(b){_.debounce(a.filterResults(b.target),800)})},initSort:function(){var a=this,b=a.collection.attributes.sort,c=new APP.SortView({collection:b});$(".sort-by").append(c.$el),c.on("sorted_Changed",function(b){a.filterResults(b.target)})},initFacet:function(){var a=this;APP.facetsView=new APP.FacetsView({collection:a.collection.attributes.facets}),$(".filters-wrapper").append(APP.facetsView.$el),APP.facetsView.on("filter_Changed",function(b){a.filterResults(b.target)})},initSelectedFilters:function(){this.selectedFilters=new APP.SelectedFiltersView({el:$(".selected-filters-wrapper")})},removedSelectedFilter:function(a){var b=a.target;name=b.attr("data-facet-name"),facet=b.attr("data-facet");var c=$('.facet[data-facet="'+facet+'"][data-facet-name="'+name+'"]')[0];this.filterResults(c)},filterResults:function(a){var b=$(a),c=(b.parent(),!1);if(b.is("input")){c=!0;var d=b.val();""===d&&b.hasClass("active")?b.removeClass("active"):b.addClass("active")}else b.is("option")?b.addClass("active").siblings().removeClass("active"):b.hasClass("active")?b.removeClass("active"):b.addClass("active").siblings().removeClass("active");a.preventDefault&&a.preventDefault();var e=[];$("body").find(".active").each(function(){var a=$(this),b=a.attr("data-facet"),c=a.attr("data-facet-name");e.push(b+"="+escape(c))}),window.location.hash=e.length?"!/search?"+e.join("&"):"!/"}}),APP.FacetsView=Backbone.View.extend({template:Handlebars.compile('<div class="filter-wrapper"><h2>{{heading}}</h2><ul class={{facet}}>{{#each options}}<li class="facet" data-facet="{{setToLowerCase ../facet}}" data-facet-name="{{setToLowerCase this.facet}}">{{this.title}}<span class="remove"></span></li>{{/each}}</ul></div>'),events:{"click .facet":"filterResults"},initialize:function(){this.render()},filterResults:function(a){this.trigger("filter_Changed",{target:a.target})},render:function(){var a=this,b=a.collection;_.each(b,function(a){this.$el.append(this.template(a))},this)}}),APP.GraphicCollectionView=Backbone.View.extend({template:Handlebars.compile('<div class="show-more">show more</div>'),page:0,limit:12,totalGraphics:0,events:{"click .show-more":"onShowMore"},initialize:function(){this.on("reset",this.render,this)},render:function(){var a=this;a.$el.html(""),a.totalGraphics=a.collection.length,a.updateTotalGraphics(),this.page=0,a.renderProjectGroup(a.page,a.limit-1),a.limit<=a.totalGraphics&&a.$el.append(a.template)},addOne:function(a){var b=new APP.GraphicItemView({model:a});this.$el.append(b.render().el)},renderProjectGroup:function(a,b){b>this.totalGraphics&&(b=this.totalGraphics-1);var c=_.filter(this.collection.models,function(c,d){return d>=a&&b>=d});_.each(c,function(a){this.addOne(a)},this)},updateTotalGraphics:function(){$(".total-graphics").html("<span class='bold'>"+this.totalGraphics+"</span> graphics")},onShowMore:function(){this.page++;var a=this.page*this.limit,b=a+this.limit-1;$(".show-more").remove(),a<this.totalGraphics-1&&(this.renderProjectGroup(a,b),this.$el.append(this.template))}}),APP.GraphicItemView=Backbone.View.extend({tagName:"article",className:"graphic",template:Handlebars.compile('<div class="inner-graphics-wrapper"><div class="image-wrapper"><a href="{{ url }}" target="_blank" title="{{ title }}" ><img class="graphics-image" src={{getImgPath this}}><div class="date">{{formatDate date}}</div></a></div><h2 class="{{setFavicon newspaper}}"><span>{{title}}</span></h2></div>'),render:function(){var a=this,b=a.model.attributes;a.$el.html(a.template(b));var c=a.$el.find("img.graphics-image");return c[0].complete?c.hide().fadeIn(200):c.hide().on("load",function(b){a.img_loaded(b)}),a},img_loaded:function(a){$(a.target).fadeIn(400)}}),APP.ScrollView=Backbone.View.extend({initialize:function(){$(window).scroll(this.onScrolling),Backbone.isiPad&&$(window).on({touchmove:this.onScrolling}),$(".scroll-to-top").click(this.goToTop)},goToTop:function(){return $("html,body").animate({scrollTop:0},"slow"),!1},onScrolling:function(){var a=$(window).scrollTop(),b=$(window).height(),c=$("body").height();a>34&&c>b?($(".fixed-menu-wrapper").addClass("fixed"),a>800?$(".scroll-to-top").fadeIn(600):$(".scroll-to-top").fadeOut(200)):($(".fixed-menu-wrapper").removeClass("fixed"),$(".scroll-to-top").hide()),a+$(window).height()==$(document).height()&&APP.graphicCollectionView.onShowMore()}}),APP.SearchView=Backbone.View.extend({template:Handlebars.compile('<div class="search"><input class="search-input" data-facet="title" data-facet-name="" type="search" placeholder="search title" ></div>'),events:{"keyup .search":"onSearch"},initialize:function(){Backbone.controller.on("checkSearch",this.checkSearch,this),this.render()},checkSearch:function(a){var b=$(".search-input"),c=b.val();c!=a.search&&this.updateSearch(a.search)},render:function(){return this.$el.html(this.template),this},updateSearch:function(a){var b=$(".search-input"),c=b.attr("data-facet-name");c=a,b.attr("data-facet-name",c),b.val(a)},onSearch:function(){var a=$(".search-input"),b=a.val();""!==b&&this.updateSearch(b),this.trigger("search_Changed",{target:a})}}),APP.SelectedFiltersView=Backbone.View.extend({tagName:"div",className:"filter",template:Handlebars.compile('<div class="filter-label" data-facet="{{category}}" data-facet-name="{{facet}}"><div class="name">{{name}}</div><span class="remove"></span> </div>'),events:{"click .filter-label":"onClickFilterLabel"},initialize:function(){this._hash=[],Backbone.controller.on("selectedFilter",this.selectedFilter,this),Backbone.controller.on("removeFilters",this.removeAll,this)},onClickFilterLabel:function(a){a.preventDefault();var b=$(a.target).parent();Backbone.controller.trigger("removedSelectedFilter",{target:b}),this.removeFacet(b.attr("data-facet"))},selectedFilter:function(a){var b=this;this.updateLabel(a);_.filter(this._hash,function(c){for(var d in a.arr){var e=$(a.arr[d]),f=e.attr("data-facet");if(facet=e.attr("data-facet-name"),c.category===f)return!0}b.removeFacet(c.category)})},removeFacet:function(a){var b=$('.filter-label[data-facet="'+a+'"]')[0];b.remove(),this._hash=_.without(this._hash,_.findWhere(this._hash,{category:a})),0===this._hash.length&&$(".filter-info").remove()},removeAll:function(){this._hash=[],$(".filter-label").remove(),$(".filter-info").remove()},updateLabel:function(a){var b=$(a.el),c=b.attr("data-facet"),d=b.text(),e=b.attr("data-facet-name");if("sort"!==c){var f=_.filter(this._hash,function(a){return a.category===c});if(1===f.length){var g=$('.filter-label[data-facet="'+c+'"]');g.find(".name").html(d),data=e,g.attr("data-facet-name",data),this._hash=_.without(this._hash,_.findWhere(this._hash,{category:c}))}else 0===this._hash.length&&this.$el.append("<span class='filter-info'>active filter:</span>"),this.$el.append(this.template({category:c,name:d,facet:e}));this._hash.push({category:c,name:d,facet:e})}}}),APP.SortView=Backbone.View.extend({tagName:"div",className:"filter",template:Handlebars.compile('<span class="label">Sort By</span><select class="sort-by">{{#each sort}}<option class="facet option-sort" data-facet="sort" data-facet-name="{{this.facet}}">{{this.title}}</option>{{/each}}</select>'),events:{"change select":"selectionChanged"},initialize:function(){this.render(),Backbone.controller.on("checkSort",this.updateSort,this)},render:function(){var a=this,b=a.collection;this.$el.append(this.template(b))},updateSort:function(a){var b=$('.facet[data-facet-name="'+a.param+'"]');b.prop("selected",!0),b.addClass("active")},selectionChanged:function(a){a.preventDefault();var b=$(a.currentTarget),c=$("option:selected",b);this.trigger("sorted_Changed",{target:c})}}),APP.Router=Backbone.Router.extend({prev:!1,routes:{"!/":"index","!/search":"filterResults"},initialize:function(){var a=this;APP.facets=new APP.Facets,APP.facets.fetch({success:function(a){APP.facetsData=a,APP.facets.trigger("dataLoaded")}}),APP.facets.on("dataLoaded",function(){new APP.FacetsMasterView({collection:APP.facetsData});a.startRouter()}),APP.graphics=new APP.Graphics,APP.graphics.fetch({success:function(a){APP.collectionData=a,APP.graphics.trigger("dataLoaded")}}),APP.graphics.on("dataLoaded",function(){a.renderGraphics(APP.collectionData),a.startRouter()}),APP.scroll=new APP.ScrollView},startRouter:function(){APP.router.prev?Backbone.history.start():APP.router.prev=!0},renderGraphics:function(a){APP.graphicCollectionView=new APP.GraphicCollectionView({collection:a,el:$(".graphics-wrapper")}),APP.graphicCollectionView.render()},filterResults:function(a){var b=this.search(a),c=new Array,d=new Array;if($facets=$(".facet"),$facets.removeClass("active"),_.each(a,function(a,b){c.push(b),d.push(a)}),d.length){var e=_.filter($facets,function(a){var b=$(a).data("facet-name");return-1!=_.indexOf(d,b)?!0:!1});_.each(e,function(a){Backbone.controller.trigger("selectedFilter",{el:a,arr:e})}),$(e).addClass("active")}this.renderGraphics(b)},search:function(a){var b,c=this,d=APP.collectionData,e=!1;return a.sort&&(APP.graphics.sortByColumn(a.sort),Backbone.controller.trigger("checkSort",{param:a.sort}),e=a.sort,delete a.sort),_.size(a)?(a.title&&Backbone.controller.trigger("checkSearch",{search:a.title}),_.each(a,function(a,b){var a=c.escapeRegex(a),e=new RegExp(a,"i");d=d.filter(function(a){return e.lastIndex=0,e.test(a.get(b))})}),b=new Backbone.Collection(d)):b=d,e&&(a.sort=e),b},escapeRegex:function(a){return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},notFound:function(){console.log("404 message here")},index:function(){var a=this;$(".facet").removeClass("active"),a.renderGraphics(APP.collectionData),Backbone.controller.trigger("removeFilters")}}),APP.router=new APP.Router;