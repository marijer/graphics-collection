var m_names=new Array("January","February","March","April","May","June","July","August","September","October","November","December");Handlebars.registerHelper("formatDate",function(a){a=String(a);var b=a.substring(0,4),c=a.substring(4,6);c=c.replace(/^0+/,"");var d=m_names[c-1];return d+", "+b}),Handlebars.registerHelper("getImgPath",function(a){var b=a.thumbnail,c="Guardian"===a.newspaper?"guardian":"nytimes",d="http://marijerooze.nl/thesis/graphics/images/"+c+"/"+b;return d}),Handlebars.registerHelper("setFavicon",function(a){var b="Guardian"===a?"gua":"nyt";return b+=" favicon"}),Handlebars.registerHelper("setRightFacet",function(a,b){var c;return c=a.independent?b.facet:a.facet,c.toLowerCase()}),Handlebars.registerHelper("setSelected",function(a,b){return sel=a.selection===b?"selected":""}),Handlebars.registerHelper("isExpanded",function(a){var b=a?"expanded":"collapsed";return b});var APP=window.APP={};Backbone.controller=_.extend({},Backbone.Events),Backbone.isiPad=null!=navigator.userAgent.match(/iPad/i),APP.Facets=Backbone.Model.extend({url:"../facets",defaults:{facet:"",heading:"",sort_order:""}}),APP.Graphic=Backbone.Model.extend({defaults:{id:"",title:"undefined",date:"unknown",source:"unknown",creators:"unknown",favorite:!1,thumbnail:"public/img/graphics/test.jpg",news_type:"unknown",annotation:"unknown",flash:"unknown"},parse:function(a){return paper=a.newspaper,newscategory=a.newscategory,"guardian"==paper&&(a.newspaper="gua"),"Ny Times"==paper&&(a.newspaper="nyt"),"Economy"==newscategory&&(a.newscategory="business"),a}}),APP.Graphics=Backbone.Collection.extend({model:APP.Graphic,url:"../graphics",sortKey:"desc",comparator:function(a,b){return name1=a.get(this.sortKey).toLowerCase(),name2=b.get(this.sortKey).toLowerCase(),ret=name2>name1?-1:name1>name2?1:0,"desc"===this.sort_dir&&(ret=-ret),ret},initialize:function(){this.sortByColumn(this.sortKey)},sortByColumn:function(a){this.sortkey=a,"asc"===a?(this.sort_dir="asc",this.sortKey="date"):"desc"===a?(this.sort_dir="desc",this.sortKey="date"):(this.sort_dir="desc",this.sortKey="id"),this.sort()},byYear:function(a,b){return filtered=this.filter(function(c){var d=String(c.get("date")).substring(0,4),e=d>=a&&b>=d?!0:!1;return e}),new APP.Graphics(filtered)},byFilters:function(a){var b,c=this,d=this,e=!1;if(a.years){var f=a.years.split("-");Backbone.controller.trigger("checkSlider",{param:a.years}),e=a.years,d=this.byYear(f[0],f[1]),delete a.years}var g=!1;return a.sort&&(d.sortByColumn(a.sort),Backbone.controller.trigger("checkSort",{param:a.sort}),g=a.sort,delete a.sort),_.size(a)?(a.title&&Backbone.controller.trigger("checkSearch",{search:a.title}),_.each(a,function(a,b){var a=c.escapeRegex(a),e=new RegExp(a,"i");d=d.filter(function(a){return e.lastIndex=0,e.test(a.get(b))})}),b=new Backbone.Collection(d)):b=d,g&&(a.sort=g),e&&(a.years=e),b},escapeRegex:function(a){return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}}),APP.FacetsMasterView=Backbone.View.extend({initialize:function(){this.initSearch(),this.initSort(),this.initFacet(),this.initSelectedFilters(),this.initSliderView(),this.initPanelView(),Backbone.controller.on("removedSelectedFilter",this.removedSelectedFilter,this)},initSearch:function(){var a=this,b=new APP.SearchView({el:$(".search-wrapper")});b.on("search_Changed",function(b){_.debounce(a.filterResults(b.target),800)})},initSort:function(){var a=this,b=a.collection.attributes.sort,c=new APP.SortView({collection:b});$(".sort-wrapper").append(c.$el),c.on("sorted_Changed",function(b){a.filterResults(b.target)})},initFacet:function(){var a=this;APP.facetsView=new APP.FacetsView({collection:a.collection.attributes.facets}),$(".filters-wrapper").append(APP.facetsView.$el),APP.facetsView.on("filter_Changed",function(b){a.filterResults(b.target)})},initSelectedFilters:function(){this.selectedFilters=new APP.SelectedFiltersView({el:$(".selected-filters-wrapper")})},initSliderView:function(){var a=this;APP.sliderView=new APP.SliderView({el:$(".slider-wrapper")}),APP.sliderView.on("slider_Changed",function(b){a.filterResults(b.target)})},initPanelView:function(){APP.panelView=new APP.PanelView({el:$(".mobile-menu")}),APP.panelView.render()},removedSelectedFilter:function(a){var b=a.target;name=b.attr("data-facet-name"),facet=b.attr("data-facet");var c=$('.facet[data-facet="'+facet+'"][data-facet-name="'+name+'"]')[0];this.filterResults(c,!0)},filterResults:function(a,b){var c=$(a),d=(c.parent(),!1);if(c.is("input[type=slider]")){var e=c.slider("value"),f=e.split(";"),g=Number(f[0]),h=Number(f[1]);g!==APP.sliderView.minYear||h!==APP.sliderView.maxYear?c.addClass("active"):c.removeClass("active"),b&&(c.removeClass("active"),APP.sliderView.reset())}else if(c.is("input")){d=!0;var i=c.val();""===i&&c.hasClass("active")?c.removeClass("active"):c.addClass("active")}else c.is("option")?c.addClass("active").siblings().removeClass("active"):c.hasClass("active")?c.removeClass("active"):c.addClass("active").siblings().removeClass("active");a.preventDefault&&a.preventDefault();var j=[];$("body").find(".active").each(function(){var a=$(this),b=a.attr("data-facet"),c=a.attr("data-facet-name");j.push(b+"="+escape(c))}),window.location.hash=j.length?"!/search?"+j.join("&"):"!/"}}),APP.FacetsView=Backbone.View.extend({template:Handlebars.compile('<div class="filter-wrapper"><h2 class="{{isExpanded expanded}} header">{{heading}}</h2><ul class="{{facet}} {{isExpanded expanded}}">{{#each options}}<li class="facet" data-facet="{{setRightFacet .. this}}" data-facet-name="{{this.value}}">{{this.title}}<span class="remove"></span></li>{{/each}}</ul></div>'),events:{"click .facet":"filterResults","click h2":"onClickHeader"},initialize:function(){this.render()},filterResults:function(a){this.trigger("filter_Changed",{target:a.target})},onClickHeader:function(a){var b=$(a.target);b.hasClass("header")&&(b.hasClass("expanded")?(b.removeClass("expanded"),b.siblings("ul").slideUp("fast")):(b.addClass("expanded"),b.siblings("ul").slideDown("fast")))},render:function(){var a=this,b=a.collection;_.each(b,function(a){this.$el.append(this.template(a))},this)}}),APP.GraphicCollectionView=Backbone.View.extend({template:Handlebars.compile('<div class="show-more">show more</div>'),page:0,limit:12,totalGraphics:0,events:{"click .show-more":"onShowMore"},initialize:function(){this.on("reset",this.render,this)},render:function(){var a=this;a.$el.html(""),a.totalGraphics=a.collection.length,a.updateTotalGraphics(),this.page=0,a.renderProjectGroup(a.page,a.limit-1),a.limit<=a.totalGraphics&&a.$el.append(a.template)},addOne:function(a){var b=new APP.GraphicItemView({model:a});this.$el.append(b.render().el)},renderProjectGroup:function(a,b){b>this.totalGraphics&&(b=this.totalGraphics-1);var c=_.filter(this.collection.models,function(c,d){return d>=a&&b>=d});_.each(c,function(a){this.addOne(a)},this)},updateTotalGraphics:function(){$(".total-graphics").html("<span class='bold'>"+this.totalGraphics+"</span> graphics")},onShowMore:function(){this.page++;var a=this.page*this.limit,b=a+this.limit-1;$(".show-more").remove(),a<this.totalGraphics-1&&(this.renderProjectGroup(a,b),this.$el.append(this.template))}}),APP.GraphicItemView=Backbone.View.extend({tagName:"article",className:"graphic",template:Handlebars.compile('<div class="inner-graphics-wrapper"><a href="{{ url }}" class="image-wrapper" target="_blank" title="{{ title }}" ><img class="graphics-image" src={{getImgPath this}}><div class="date">{{formatDate date}}</div></a><h2 class="{{setFavicon newspaper}}"><span>{{title}}</span></h2></div>'),render:function(){var a=this,b=a.model.attributes;a.$el.html(a.template(b));{var c=a.$el.find("img.graphics-image");a.$el.find("a")}return c[0].complete?c.css("opacity",.3).animate({opacity:1},400):c.hide().on("load",function(b){a.img_loaded(b)}),a},img_loaded:function(a){$(a.target).fadeIn(400)}}),APP.PanelView=Backbone.View.extend({isHidden:!0,template:Handlebars.compile('<div class="panelViewWrapper">Show Menu</div>'),events:{"click .panelViewWrapper":"onClick"},onClick:function(){var a=$(".panel-wrapper");a.hasClass("show-menu")?(a.removeClass("show-menu"),$(".panelViewWrapper").html("Show Menu")):(a.addClass("show-menu"),$(".panelViewWrapper").html("Hide Menu"))},render:function(){return this.$el.html(this.template),this}}),APP.ScrollView=Backbone.View.extend({timer:void 0,initialize:function(){Backbone.isiPad||$(window).scroll(this.onScrolling),$(".scroll-to-top").click(this.goToTop)},goToTop:function(){return $("html,body").animate({scrollTop:0},"slow"),!1},onScrolling:function(){var a=$(window).scrollTop(),b=$(window).height(),c=$("body").height();a>33&&c>b?($(".fixed-menu-wrapper").addClass("fixed"),a>800?$(".scroll-to-top").fadeIn(600):$(".scroll-to-top").fadeOut(200)):($(".fixed-menu-wrapper").removeClass("fixed"),$(".scroll-to-top").hide()),a+$(window).height()===$(document).height()&&APP.graphicCollectionView.onShowMore()}}),APP.SearchView=Backbone.View.extend({template:Handlebars.compile('<div class="search"><input class="search-input" data-facet="title" data-facet-name="" type="search" placeholder="search on title" ></div>'),events:{"keyup .search":"onSearch"},initialize:function(){Backbone.controller.on("checkSearch",this.checkSearch,this),this.render()},checkSearch:function(a){var b=$(".search-input"),c=b.val();c!=a.search&&this.updateSearch(a.search)},render:function(){return this.$el.html(this.template),this},updateSearch:function(a){var b=$(".search-input"),c=b.attr("data-facet-name");c=a,b.attr("data-facet-name",c),b.addClass("active"),b.val(a)},onSearch:function(){var a=$(".search-input"),b=a.val();""!==b&&this.updateSearch(b),this.trigger("search_Changed",{target:a})}}),APP.SelectedFiltersView=Backbone.View.extend({tagName:"div",className:"filter",template:Handlebars.compile('<div class="filter-label tooltip" data-tip-type="text" data-facet="{{category}}" data-facet-name="{{facet}}"><div class="name">{{name}}</div><span class="remove"></span> </div>'),events:{"click .filter-label":"onClickFilterLabel"},initialize:function(){this._hash=[],Backbone.controller.on("selectedFilter",this.selectedFilter,this),Backbone.controller.on("removeFilters",this.removeAll,this),this.$el.append("<span class='filter-info'>active filter(s):</span>")},onClickFilterLabel:function(a){a.preventDefault();var b=$(a.target);b.hasClass("filter-label")||(b=$(a.target).parent()),Backbone.controller.trigger("removedSelectedFilter",{target:b}),this.removeFacet(b.attr("data-facet"))},selectedFilter:function(a){var b=this;this.updateLabel(a);_.filter(this._hash,function(c){for(var d in a.arr){var e=$(a.arr[d]),f=e.attr("data-facet");if(facet=e.attr("data-facet-name"),c.category===f)return!0}b.removeFacet(c.category)})},removeFacet:function(a){var b=$('.filter-label[data-facet="'+a+'"]')[0];b.remove(),this._hash=_.without(this._hash,_.findWhere(this._hash,{category:a})),0===this._hash.length&&$(".filter-info").removeClass("hasFilter")},removeAll:function(){this._hash=[],$(".filter-label").remove(),$(".filter-info").removeClass("hasFilter")},updateLabel:function(a){var b=$(a.el),c=b.attr("data-facet"),d=b.text()||b.attr("data-facet-name"),e=b.attr("data-facet-name");if("sort"!==c){var f=_.filter(this._hash,function(a){return a.category===c});if(1===f.length){var g=$('.filter-label[data-facet="'+c+'"]');g.find(".name").html(d),data=e,g.attr("data-facet-name",data),this._hash=_.without(this._hash,_.findWhere(this._hash,{category:c}))}else{0===this._hash.length&&$(".filter-info").addClass("hasFilter");var h=this.template({category:c,name:d,facet:e});this.$el.append(h)}this._hash.push({category:c,name:d,facet:e})}}}),APP.SliderView=Backbone.View.extend({minYear:2e3,maxYear:2014,template:Handlebars.compile('<input id="Slider" type="slider" class="facet" data-facet="years" name="area" value="2000;2014" data-facet-name="2000-2014" style="display:none;" />'),initialize:function(){var a=this;this.$el.html(this.template);var b=$("#Slider");b.slider({from:a.minYear,to:a.maxYear,step:1,smooth:!1,skin:"round_plastic",format:{format:"####"},round:0,dimension:"",callback:function(){a.slideYear(b)}}),Backbone.controller.on("checkSlider",this.checkSlider,this)},slideYear:function(a){var b=$(a),c=b.slider("value"),d=(c.split(";"),b.attr("data-facet-name"));d=c.replace(";","-"),b.attr("data-facet-name",d),this.trigger("slider_Changed",{target:b})},checkSlider:function(a){var b=a.param.split("-");this.updateSlider(b[0],b[1])},updateSlider:function(a,b){var c=$("#Slider");c.slider("value",a,b);var d=c.attr("data-facet-name");d=a+"-"+b,c.attr("data-facet-name",d)},reset:function(){this.updateSlider(this.minYear,this.maxYear)}}),APP.SortView=Backbone.View.extend({tagName:"div",className:"filter",template:Handlebars.compile('<div class="sort-label"> sort<div class="sort-options-wrapper"><ul class="sort-by">{{#each sort}}<li class="facet option-sort" data-facet="sort" data-facet-name="{{this.facet}}">{{this.title}}</li>{{/each}}</ul></div></div>'),events:{"click .sort-label":"clickSortLabel","click .option-sort":"selectionChanged"},initialize:function(){this.render(),Backbone.controller.on("checkSort",this.updateSort,this)},render:function(){var a=this,b=a.collection;this.$el.append(this.template(b))},updateSort:function(a){var b=$('.facet[data-facet-name="'+a.param+'"]');b.prop("selected",!0),b.addClass("active")},clickSortLabel:function(a){a.preventDefault();var b=$(a.target);b.hasClass("selected")?b.removeClass("selected"):b.addClass("selected")},selectionChanged:function(a){a.preventDefault();var b=$(a.target);this.trigger("sorted_Changed",{target:b}),$(".sort-label").removeClass("selected")}}),APP.Router=Backbone.Router.extend({prev:!1,routes:{"!/":"index","!/search":"filterResults"},initialize:function(){var a=this;APP.graphics=new APP.Graphics,APP.graphics.fetch({success:function(a){APP.collectionData=a,APP.graphics.trigger("dataLoaded")}}),APP.graphics.on("dataLoaded",function(){a.renderGraphics(APP.collectionData),a.startRouter()}),APP.facets=new APP.Facets,APP.facets.fetch({success:function(a){APP.facetsData=a,APP.facets.trigger("dataLoaded")}}),APP.facets.on("dataLoaded",function(){new APP.FacetsMasterView({collection:APP.facetsData});a.startRouter()}),APP.scroll=new APP.ScrollView},startRouter:function(){APP.router.prev?Backbone.history.start():APP.router.prev=!0},renderGraphics:function(a){APP.graphicCollectionView=new APP.GraphicCollectionView({collection:a,el:$(".graphics-wrapper")}),this.currentCollection=APP.collectionData,APP.graphicCollectionView.render()},filterResults:function(a){var b=this.search(a),c=[],d=[];if($facets=$(".facet"),$facets.removeClass("active"),_.each(a,function(a,b){c.push(b),d.push(a)}),d.length){var e=_.filter($facets,function(a){var b=$(a).data("facet-name"),e=$(a).data("facet");return 1===b||"years"===e?-1!=_.indexOf(c,e)?!0:!1:-1!=_.indexOf(d,b)?!0:!1});_.each(e,function(a){Backbone.controller.trigger("selectedFilter",{el:a,arr:e})}),$(e).addClass("active")}this.renderGraphics(b)},search:function(a){var b=APP.collectionData;b=b.byFilters(a);var c=_.uniq(b.pluck("newscategory"));return console.log(c.length),console.log(c),b},notFound:function(){console.log("404 message here")},index:function(){var a=this;$(".facet").removeClass("active"),a.renderGraphics(APP.collectionData),Backbone.controller.trigger("removeFilters")}}),APP.router=new APP.Router;